# ?? Student Information System - Code Explanation
# ??? ??? ???? ??????? ??????

---

## ?? ???? ???? ??? ??????? | Project Overview

??? ??????? ?? **???? ????? ??????? ??????** ???? ??:
- **Backend**: C++17
- **Frontend**: HTML5, CSS3, JavaScript, Bootstrap 5
- **Database**: MySQL 8.0
- **GUI Framework**: WebView (Microsoft Edge WebView2)

---

## ??? ???? ??????? | Project Structure

```
C++ Ass2/
??? main.cpp                    # ???? ??????? ????????
??? include/                    # ????? ??? Headers
?   ??? Database.h              # ??????? ?????? ????????
?   ??? Student.h               # ???? ??????
?   ??? Professor.h             # ???? ???????
?   ??? Course.h                # ???? ??????
?   ??? Grade.h                 # ???? ???????
?   ??? SessionManager.h        # ????? ??????? ??????????
?   ??? JsonHelper.h            # ????? ????? JSON
??? src/                        # ????? ???????
?   ??? Student.cpp
?   ??? Professor.cpp
?   ??? Course.cpp
?   ??? Grade.cpp
?   ??? SessionManager.cpp
?   ??? JsonHelper.cpp
??? web/                        # ????? ????????
?   ??? index.html              # ???? ????? ??????
?   ??? dashboard.html          # ???? ??????
?   ??? students.html           # ????? ??????
?   ??? professors.html         # ????? ????????
?   ??? courses.html            # ????? ??????
?   ??? grades.html             # ????? ???????
?   ??? js/app.js               # JavaScript ?????
??? sql/
?   ??? schema.sql              # ????? ???????? (????)
?   ??? schema_v2.sql           # ????? ???????? (???? + RBAC)
??? lib/
    ??? webview.h               # ????? WebView
```

---

## ?? ???? ????????? (RBAC) | Role-Based Access Control

### ?? ?? RBAC?
???? ????? ?? ??????? ?????????? ????? ??? ????? (Role).

### ??????? ???????? | Main Roles:

| ????? | Role ID | ????????? |
|-------|---------|-----------|
| Super Admin | ROLE_SUPERADMIN | ?? ????????? |
| Student Affairs | ROLE_STUDENT_AFFAIRS | ????? ?????? ????????? |
| Professor | ROLE_PROFESSOR | ????? ??????? ??????? |
| Student | ROLE_STUDENT | ??? ??????? ??? |

### ??? ?????

```cpp
// ?? SessionManager.h - ????? ?????????
namespace Permissions {
    const string STU_VIEW_ALL = "student.view";      // ??? ?? ??????
    const string STU_CREATE = "student.create";      // ????? ????
    const string STU_EDIT = "student.update";        // ????? ????
    const string GRD_ENTER = "grade.enter";          // ????? ?????
}

// ?????? ?? ????????
if (SessionManager::hasPermission(Permissions::STU_CREATE)) {
    // ???????? ???? ???? ????
}
```

---

## ??? ????? ???????? | Database

### ??????? ???????? | Database Connection

```cpp
// ?? Database.h
class Database {
private:
    MYSQL* conn;           // ???? ???????
    string host = "localhost";
    string user = "root";
    string password = "admin";  // ????? ??? ?????
    string database = "nctu_sis";
    int port = 3306;

public:
    bool connect() {
        conn = mysql_init(NULL);
        mysql_real_connect(conn, host.c_str(), user.c_str(), 
                          password.c_str(), database.c_str(), port, NULL, 0);
    }
};
```

### ??????? ???????? | Main Tables:

```sql
-- ???? ??????????
users (id, username, password_hash, full_name, role_id, is_active)

-- ???? ???????
roles (id, name_en, description)

-- ???? ?????????
permissions (id, name, description)

-- ??? ??????? ??????????
role_permissions (role_id, permission_id)

-- ???? ??????
students (id, first_name, last_name, user_id, department_id, academic_level_id)

-- ???? ????????
professors (id, first_name, last_name, user_id, department_id)

-- ???? ??????
courses (id, code, name_en, department_id, max_marks)

-- ???? ???????
registrations (id, student_id, course_id, semester_id, status)

-- ???? ???????
grades (id, registration_id, assignment1, assignment2, year_work, final_exam, total_marks)
```

---

## ?? WebView Binding | ??? C++ ?? JavaScript

### ??????? ???????:
WebView ???? ??? ?????? ???? C++ ?? JavaScript ??????.

### ??? ?????

```cpp
// ?? main.cpp - ??? ???? C++ ???? JavaScript
w.bind("cpp_login", [](const string& request) -> string {
    // request = JSON ?? JavaScript
    string username = JsonHelper::parseSimpleValue(request, "username");
    string password = JsonHelper::parseSimpleValue(request, "password");
    
    if (SessionManager::login(db, username, password)) {
        return "{\"success\": true}";
    }
    return "{\"success\": false}";
});
```

```javascript
// ?? JavaScript - ??????? ??????
async function login() {
    const response = await cpp_login({
        username: "superadmin",
        password: "admin123"
    });
    
    if (response.success) {
        window.location.href = "dashboard.html";
    }
}
```

---

## ?? ??? ?????? ???????? | Main Functions Explained

### 1. ????? ?????? | Login

```cpp
// SessionManager::login()
bool SessionManager::login(Database& db, const string& username, const string& password) {
    // 1. ????? ?? ???????? ?? ????? ????????
    auto stmt = db.prepareStatement(
        "SELECT u.id, u.username, u.full_name, u.role_id, r.name_en as role_name "
        "FROM users u "
        "JOIN roles r ON u.role_id = r.id "
        "WHERE u.username = ? AND u.password_hash = ? AND u.is_active = TRUE"
    );
    
    // 2. ????? ?????
    stmt->setString(1, username);
    stmt->setString(2, password);
    
    // 3. ????? ?????????
    auto result = stmt->executeQuery();
    
    if (result->next()) {
        // 4. ??? ?????? ??????
        currentSession.userId = result->getString("id");
        currentSession.roleId = result->getString("role_id");
        
        // 5. ????? ?????????
        currentSession.permissions = loadPermissions(db, currentSession.roleId);
        
        return true;
    }
    return false;
}
```

### 2. ????? ???? | Add Student

```cpp
// cpp_addStudent ?? main.cpp
w.bind("cpp_addStudent", [](const string& request) -> string {
    // 1. ?????? ?? ????????
    if (!SessionManager::hasPermission(Permissions::STU_CREATE)) {
        return JsonHelper::errorResponse("Permission denied");
    }
    
    // 2. ??????? ???????? ?? JSON
    string id = JsonHelper::parseSimpleValue(request, "id");
    string firstName = JsonHelper::parseSimpleValue(request, "firstName");
    // ... ???? ????????
    
    // 3. ?????? ?? ??? ???????
    if (Student::exists(db, id)) {
        return JsonHelper::errorResponse("Student ID already exists!");
    }
    
    // 4. ????? ???? ?????? ?????
    Student student(id, firstName, lastName, ...);
    if (student.save(db)) {
        // 5. ????? ?????? ?? ?????? ????????
        // ... ??? ??????? ????????
        
        return JsonHelper::successResponse("Student added successfully!");
    }
});
```

### 3. ???? ??????? | Grade Calculation

```cpp
// Grade::calculateGrade()
void Grade::calculateGrade(Database& db, const string& registrationId) {
    // 1. ??? ????? ?????? ???????? ??????
    auto stmt = db.prepareStatement(
        "SELECT g.*, c.max_marks, c.year_work_marks, c.final_exam_marks "
        "FROM grades g "
        "JOIN registrations r ON g.registration_id = r.id "
        "JOIN courses c ON r.course_id = c.id "
        "WHERE g.registration_id = ?"
    );
    
    // 2. ???? ???????
    double total = assignment1 + assignment2 + yearWork + finalExam;
    
    // 3. ???? ?????? ???????
    double percentage = (total / maxMarks) * 100;
    
    // 4. ????? ???????
    string letterGrade, evaluation;
    double gpa;
    
    if (percentage >= 90) {
        letterGrade = "A+"; evaluation = "Excellent"; gpa = 4.0;
    } else if (percentage >= 85) {
        letterGrade = "A"; evaluation = "Excellent"; gpa = 3.7;
    }
    // ... ???? ?????????
    
    // 5. ????? ????? ????????
    auto updateStmt = db.prepareStatement(
        "UPDATE grades SET total_marks=?, percentage=?, gpa=?, "
        "letter_grade=?, evaluation=? WHERE registration_id=?"
    );
}
```

---

## ?? ??????? ???????? | Frontend

### ???? ???????:

```html
<!-- index.html - ???? ????? ?????? -->
<form onsubmit="handleLogin(event)">
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button type="submit">Login</button>
</form>

<script>
async function handleLogin(e) {
    e.preventDefault();
    
    const response = await cpp_login({
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
    });
    
    if (response.success) {
        // ??? ?????? ??????
        sessionStorage.setItem('userId', response.id);
        sessionStorage.setItem('userRole', response.role);
        sessionStorage.setItem('permissions', JSON.stringify(response.permissions));
        
        // ???????? ????? ??????
        window.location.href = 'dashboard.html';
    }
}
</script>
```

### ?????? ?? ????????? ?? JavaScript:

```javascript
// ?? app.js
function hasPermission(permissionName) {
    const permissions = JSON.parse(sessionStorage.getItem('permissions') || '[]');
    return permissions.includes(permissionName);
}

// ???????
if (hasPermission('student.create')) {
    document.getElementById('addStudentBtn').style.display = 'block';
}
```

---

## ?? ?????? | Security

### 1. Prepared Statements (??? SQL Injection):
```cpp
// ? ??? - ???? ????????
string query = "SELECT * FROM users WHERE username = '" + username + "'";

// ? ???? - ???
auto stmt = db.prepareStatement("SELECT * FROM users WHERE username = ?");
stmt->setString(1, username);
```

### 2. ?????? ?? ?????????:
```cpp
// ?? ???? ????? ?? ???????? ?????
if (!SessionManager::hasPermission(Permissions::STU_DELETE)) {
    return JsonHelper::errorResponse("Permission denied");
}
```

### 3. ?????? ?? ??????:
```cpp
if (!SessionManager::isLoggedIn()) {
    return JsonHelper::errorResponse("Not logged in");
}
```

---

## ?? ??? ????? | Workflow

### ????? ??????:
```
1. ???????? ???? ??? ???????? ????? ??????
2. JavaScript ?????? cpp_login()
3. C++ ????? ?? ???????? ?? MySQL
4. ??? ?????: ????? ????????? ?????? ??????
5. ????? ???????? ?? JavaScript
6. ??? ???????? ?? sessionStorage
7. ???????? ?? dashboard.html
```

### ????? ????:
```
1. ???????? ???? ??????? ????? ???
2. JavaScript ???? ???????? ??????? cpp_addStudent()
3. C++ ????? ?? ????????
4. C++ ????? ?? ??? ????? ??? ID
5. C++ ???? ?????? ?? ????? ????????
6. C++ ???? ???? ?????? ??????
7. C++ ???? ?????? ?? ?????? ????????
8. ????? ????? ??????
```

---

## ??? ????? ??????? | Running the Project

### ?????????:
1. Visual Studio 2022
2. MySQL Server 8.0+
3. Microsoft Edge WebView2 Runtime

### ???????:
```bash
# 1. ????? setup.bat ?? Administrator
./setup.bat

# 2. ????? ????? ????????
./setup_database.bat

# 3. ??? ??????? ?? Visual Studio
# 4. Build (Ctrl+Shift+B)
# 5. Run (F5)
```

### ?????? ?????? ??????????:
| ???????? | ???? ?????? | ????? |
|----------|-------------|-------|
| superadmin | admin123 | Super Admin |
| affairs | affairs123 | Student Affairs |

---

## ?? ??????? ??????? | Common Issues

### 1. ??? ?? ??????? ?????? ????????:
```
ERROR: Cannot connect to database!
```
**????**: ???? ??:
- MySQL ????
- ???? ?????? ????? ?? Database.h
- ????? ???????? nctu_sis ??????

### 2. ?????? ?????:
**????**: ???? ?? ????? WebView2 Runtime

### 3. Unknown column error:
**????**: ???? ?? ????? schema_v2.sql ??????

---

## ?? ??????? ???? | Important Notes

1. **?? ??????? ??? C++ ? JavaScript ??? ??? JSON**
2. **????????? ??? ??????? ??? ????? ??? ????? ??????**
3. **?? ????? ????? ??? ??????? ?? audit_log**
4. **?????? ????? ???????? ?? ???? ???? ???????**
5. **??????? ????? ???????? ??? ????? ?? ???? ?????**

---

## ????? ???????? | For Developers

### ????? ?????? ?????:
1. ????? ?? `SessionManager.h`:
```cpp
namespace Permissions {
    const string NEW_PERM = "new.permission";
}
```

2. ????? ?? ????? ????????:
```sql
INSERT INTO permissions (id, name) VALUES ('PERM_NEW', 'new.permission');
```

3. ?????? ?????? ???????:
```sql
INSERT INTO role_permissions (role_id, permission_id) VALUES ('ROLE_X', 'PERM_NEW');
```

### ????? API ????:
```cpp
w.bind("cpp_newFunction", [](const string& request) -> string {
    // 1. ?????? ?? ????????
    if (!SessionManager::hasPermission("required.permission")) {
        return JsonHelper::errorResponse("Permission denied");
    }
    
    // 2. ????? ??????
    // ...
    
    // 3. ????? ???????
    return JsonHelper::successResponse("Done!");
});
```

---

**?? ????? ??? ????? ???????? ?? ??? ???? ???????** ??
