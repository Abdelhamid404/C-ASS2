<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCTU - Permissions</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="d-flex">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-dark text-white vh-100 p-3">
            <div class="text-center mb-4">
                <i class="bi bi-mortarboard-fill display-6"></i>
                <h5 class="mb-0">NCTU</h5>
                <small class="text-white-50" style="font-size: 0.65rem;">New Cairo Technological University</small>
                <hr class="border-secondary my-2">
                <small id="userNameDisplay" class="text-white-50">User</small>
                <br>
                <span id="userRoleBadge" class="badge bg-primary">Role</span>
            </div>
            <hr class="border-secondary">
            <ul id="sidebarMenu" class="nav flex-column"></ul>
            <hr class="border-secondary mt-auto">
            <a href="index.html" class="nav-link text-danger" onclick="sessionStorage.clear()">
                <i class="bi bi-box-arrow-left me-2"></i> Logout
            </a>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow-1 main-content">
            <!-- Header -->
            <div class="bg-white shadow-sm p-3 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-shield-lock me-2 text-danger"></i>
                        Permissions Management
                    </h4>
                    <div>
                        <button class="btn btn-success me-2" id="newRoleBtn" onclick="showRoleModal()">
                            <i class="bi bi-plus-circle me-2"></i> New Role
                        </button>
                        <button class="btn btn-danger" id="saveBtn" onclick="saveRolePermissions()">
                            <i class="bi bi-save me-2"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>

            <div class="container-fluid">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-person-badge me-2"></i> Role Details
                                </h6>
                                <div id="roleActions">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editCurrentRole()" title="Edit Role">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCurrentRole()" title="Delete Role">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <label class="form-label">Select Role</label>
                                <select class="form-select mb-3" id="roleSelect"></select>
                                <div class="border rounded p-3 bg-light-subtle mb-3">
                                    <div class="text-muted small">Role ID</div>
                                    <div id="roleIdDisplay" class="fw-semibold font-monospace">-</div>
                                </div>
                                <div class="border rounded p-3 bg-light-subtle mb-3">
                                    <div class="text-muted small">English Name</div>
                                    <div id="roleNameEnDisplay" class="fw-semibold">-</div>
                                </div>
                                <div class="border rounded p-3 bg-light-subtle mb-3">
                                    <div class="text-muted small">Arabic Name</div>
                                    <div id="roleNameArDisplay" class="fw-semibold" dir="rtl">-</div>
                                </div>
                                <div class="border rounded p-3 bg-light-subtle">
                                    <div class="text-muted small">Description</div>
                                    <div id="roleDescription" class="fw-semibold">-</div>
                                </div>
                                <div class="mt-3">
                                    <div class="text-muted small">Permissions Assigned</div>
                                    <div class="display-6" id="permissionsCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-key me-2"></i> Permissions
                                </h6>
                                <div class="input-group input-group-sm" style="max-width: 260px;">
                                    <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="permissionSearch" placeholder="Filter permissions">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 60px;">Allow</th>
                                                <th>Permission</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody id="permissionsTableBody">
                                            <tr>
                                                <td colspan="3" class="text-center text-muted py-4">
                                                    <div class="spinner-border text-danger" role="status"></div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Role Modal (Create/Edit) -->
    <div class="modal fade" id="roleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="roleModalTitle">
                        <i class="bi bi-plus-circle me-2"></i> New Role
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="roleForm" onsubmit="saveRole(event)">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Role ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control font-monospace" id="roleId" required 
                                   placeholder="e.g., ROLE_CUSTOM" pattern="[A-Z_0-9]+" 
                                   title="Use uppercase letters, numbers and underscores only">
                            <small class="text-muted">Uppercase letters, numbers, and underscores only</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">English Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="roleNameEn" required 
                                   placeholder="e.g., Custom Role">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Arabic Name</label>
                            <input type="text" class="form-control" id="roleNameAr" dir="rtl"
                                   placeholder="مثال: دور مخصص">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="roleDescInput" rows="2" 
                                      placeholder="What this role can do..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success" id="saveRoleBtn">
                            <i class="bi bi-check-circle me-1"></i> Save Role
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i> Delete Role
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this role?</p>
                    <p class="mb-0"><strong id="deleteRoleName"></strong></p>
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        System roles cannot be deleted.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteRole()">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        let roles = [];
        let permissions = [];
        let selectedPermissionIds = new Set();
        let isEditMode = false;
        let roleModal;
        let deleteRoleModal;
        let canManageRoles = false;

        document.addEventListener('DOMContentLoaded', async function() {
            initLayout('permissions');
            if (!hasPermission('user.manage')) {
                window.location.href = 'dashboard.html';
                return;
            }

            canManageRoles = hasPermission('role.manage');
            
            // Hide role management buttons if no permission
            if (!canManageRoles) {
                document.getElementById('newRoleBtn').classList.add('d-none');
                document.getElementById('roleActions').classList.add('d-none');
            }

            roleModal = new bootstrap.Modal(document.getElementById('roleModal'));
            deleteRoleModal = new bootstrap.Modal(document.getElementById('deleteRoleModal'));

            await loadRoles();
            await loadPermissions();

            const roleSelect = document.getElementById('roleSelect');
            roleSelect.addEventListener('change', () => {
                loadRolePermissions(roleSelect.value);
            });
            document.getElementById('permissionSearch').addEventListener('input', renderPermissions);

            if (roles.length > 0) {
                roleSelect.value = roles[0].id;
                await loadRolePermissions(roles[0].id);
            }
        });

        async function loadRoles() {
            roles = await cpp_getRoles();
            const roleSelect = document.getElementById('roleSelect');
            roleSelect.innerHTML = '';
            roles.forEach(role => {
                const label = `${role.nameEn} (${role.id})`;
                roleSelect.innerHTML += `<option value="${role.id}">${label}</option>`;
            });
        }

        async function loadPermissions() {
            permissions = await cpp_getPermissions();
            renderPermissions();
        }

        async function loadRolePermissions(roleId) {
            if (!roleId) return;
            const role = roles.find(r => r.id === roleId);
            
            document.getElementById('roleIdDisplay').textContent = role ? role.id : '-';
            document.getElementById('roleNameEnDisplay').textContent = role ? role.nameEn : '-';
            document.getElementById('roleNameArDisplay').textContent = role ? (role.nameAr || '-') : '-';
            document.getElementById('roleDescription').textContent = role ? (role.description || '-') : '-';

            const ids = await cpp_getRolePermissions({ roleId });
            selectedPermissionIds = new Set(ids || []);
            document.getElementById('permissionsCount').textContent = selectedPermissionIds.size;
            renderPermissions();
        }

        function renderPermissions() {
            const query = document.getElementById('permissionSearch').value.toLowerCase();
            const tbody = document.getElementById('permissionsTableBody');
            const filtered = permissions.filter(perm => {
                if (!query) return true;
                return perm.name.toLowerCase().includes(query) ||
                    (perm.description || '').toLowerCase().includes(query);
            });

            if (!filtered.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                            No permissions match your search.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(perm => `
                <tr>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input"
                               ${perm.id && selectedPermissionIds.has(perm.id) ? 'checked' : ''}
                               onchange="togglePermission('${perm.id}', this.checked)">
                    </td>
                    <td><code>${perm.name}</code></td>
                    <td>${perm.description || '-'}</td>
                </tr>
            `).join('');
        }

        function togglePermission(permissionId, isChecked) {
            if (!permissionId) return;
            if (isChecked) {
                selectedPermissionIds.add(permissionId);
            } else {
                selectedPermissionIds.delete(permissionId);
            }
            document.getElementById('permissionsCount').textContent = selectedPermissionIds.size;
        }

        async function saveRolePermissions() {
            const roleId = document.getElementById('roleSelect').value;
            if (!roleId) {
                showToast('Select a role first', 'warning');
                return;
            }
            const csv = Array.from(selectedPermissionIds).join(',');
            try {
                const response = await cpp_updateRolePermissions({
                    roleId: roleId,
                    permissions: csv
                });
                if (response.success) {
                    showToast(response.message, 'success');
                } else {
                    showToast(response.message || 'Error saving permissions', 'danger');
                }
            } catch (error) {
                console.error('Error saving permissions:', error);
                showToast('Error saving permissions', 'danger');
            }
        }

        // ========================================
        // ROLE CRUD FUNCTIONS
        // ========================================
        function showRoleModal(editRole = null) {
            if (!canManageRoles) {
                showToast('You do not have permission to manage roles', 'warning');
                return;
            }
            
            isEditMode = !!editRole;
            const form = document.getElementById('roleForm');
            form.reset();

            if (isEditMode) {
                document.getElementById('roleModalTitle').innerHTML = 
                    '<i class="bi bi-pencil me-2"></i> Edit Role';
                document.getElementById('roleId').value = editRole.id;
                document.getElementById('roleId').disabled = true;
                document.getElementById('roleNameEn').value = editRole.nameEn || '';
                document.getElementById('roleNameAr').value = editRole.nameAr || '';
                document.getElementById('roleDescInput').value = editRole.description || '';
                document.querySelector('#roleModal .modal-header').className = 'modal-header bg-primary text-white';
                document.getElementById('saveRoleBtn').className = 'btn btn-primary';
            } else {
                document.getElementById('roleModalTitle').innerHTML = 
                    '<i class="bi bi-plus-circle me-2"></i> New Role';
                document.getElementById('roleId').disabled = false;
                document.querySelector('#roleModal .modal-header').className = 'modal-header bg-success text-white';
                document.getElementById('saveRoleBtn').className = 'btn btn-success';
            }
            
            roleModal.show();
        }

        function editCurrentRole() {
            const roleId = document.getElementById('roleSelect').value;
            if (!roleId) return;
            const role = roles.find(r => r.id === roleId);
            if (role) {
                showRoleModal(role);
            }
        }

        async function saveRole(e) {
            e.preventDefault();
            
            if (!canManageRoles) {
                showToast('You do not have permission to manage roles', 'warning');
                return;
            }

            const roleData = {
                id: document.getElementById('roleId').value.trim().toUpperCase(),
                nameEn: document.getElementById('roleNameEn').value.trim(),
                nameAr: document.getElementById('roleNameAr').value.trim(),
                description: document.getElementById('roleDescInput').value.trim()
            };

            try {
                let response;
                if (isEditMode) {
                    response = await cpp_updateRole(roleData);
                } else {
                    response = await cpp_createRole(roleData);
                }

                if (response.success) {
                    showToast(response.message, 'success');
                    roleModal.hide();
                    await loadRoles();
                    
                    // Select the new/edited role
                    const roleSelect = document.getElementById('roleSelect');
                    roleSelect.value = roleData.id;
                    await loadRolePermissions(roleData.id);
                } else {
                    showToast(response.message || 'Error saving role', 'danger');
                }
            } catch (error) {
                console.error('Error saving role:', error);
                showToast('Error saving role', 'danger');
            }
        }

        function deleteCurrentRole() {
            if (!canManageRoles) {
                showToast('You do not have permission to manage roles', 'warning');
                return;
            }
            
            const roleId = document.getElementById('roleSelect').value;
            if (!roleId) return;
            
            const role = roles.find(r => r.id === roleId);
            if (!role) return;

            // Check for system roles
            const systemRoles = ['ROLE_SUPERADMIN', 'ROLE_STUDENT_AFFAIRS', 'ROLE_PROFESSOR', 'ROLE_STUDENT'];
            if (systemRoles.includes(roleId)) {
                showToast('Cannot delete system roles!', 'warning');
                return;
            }

            document.getElementById('deleteRoleName').textContent = `${role.nameEn} (${role.id})`;
            deleteRoleModal.show();
        }

        async function confirmDeleteRole() {
            const roleId = document.getElementById('roleSelect').value;
            if (!roleId) return;

            try {
                const response = await cpp_deleteRole(roleId);
                
                if (response.success) {
                    showToast(response.message, 'success');
                    deleteRoleModal.hide();
                    await loadRoles();
                    
                    // Select first role
                    if (roles.length > 0) {
                        const roleSelect = document.getElementById('roleSelect');
                        roleSelect.value = roles[0].id;
                        await loadRolePermissions(roles[0].id);
                    }
                } else {
                    showToast(response.message || 'Error deleting role', 'danger');
                }
            } catch (error) {
                console.error('Error deleting role:', error);
                showToast('Error deleting role', 'danger');
            }
        }
    </script>
</body>
</html>
