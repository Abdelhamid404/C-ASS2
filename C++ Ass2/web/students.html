<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCTU - Student Management</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="d-flex">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-dark text-white vh-100 p-3">
            <div class="text-center mb-4">
                <i class="bi bi-mortarboard-fill display-6"></i>
                <h5 class="mb-0">NCTU</h5>
                <small class="text-white-50" style="font-size: 0.65rem;">New Cairo Technological University</small>
                <hr class="border-secondary my-2">
                <small id="userNameDisplay" class="text-white-50">User</small>
                <br>
                <span id="userRoleBadge" class="badge bg-primary">Role</span>
            </div>
            <hr class="border-secondary">
            <ul id="sidebarMenu" class="nav flex-column"></ul>
            <hr class="border-secondary mt-auto">
            <a href="index.html" class="nav-link text-danger" onclick="sessionStorage.clear()">
                <i class="bi bi-box-arrow-left me-2"></i> Logout
            </a>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow-1 main-content">
            <!-- Header -->
            <div class="bg-white shadow-sm p-3 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-people me-2 text-primary"></i>
                        Student Management
                    </h4>
                    <button class="btn btn-primary" onclick="showAddModal()" data-permission="student.create">
                        <i class="bi bi-person-plus me-2"></i> Add Student
                    </button>
                </div>
            </div>

            <div class="container-fluid">
                <!-- Search and Filter -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="searchInput" 
                                           placeholder="Search by ID, name, or email...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterDepartment">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterLevel">
                                    <option value="">All Levels</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="loadStudents()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="studentsTable">
                                <thead class="table-dark" id="studentsTableHead">
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Gender</th>
                                        <th>Level</th>
                                        <th>Department</th>
                                        <th id="passwordHeader" class="d-none">Password</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Student Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="bi bi-person-plus me-2"></i> Add New Student
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="studentForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <!-- Student ID -->
                            <div class="col-md-4">
                                <label class="form-label">Student ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="studentId" required
                                       placeholder="Auto-generated (e.g., 20241)">
                                <small class="text-muted">Format: Year + Number (e.g., 20241, 20242)</small>
                                <div class="invalid-feedback">Student ID is required and must be unique</div>
                            </div>

                            <!-- First Name -->
                            <div class="col-md-4">
                                <label class="form-label">First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="firstName" required
                                       placeholder="Enter first name">
                            </div>

                            <!-- Last Name -->
                            <div class="col-md-4">
                                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="lastName" required
                                       placeholder="Enter last name">
                            </div>

                            <!-- Date of Birth -->
                            <div class="col-md-4">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="dateOfBirth">
                            </div>

                            <!-- Gender -->
                            <div class="col-md-4">
                                <label class="form-label">Gender <span class="text-danger">*</span></label>
                                <select class="form-select" id="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>

                            <!-- Email -->
                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email"
                                       placeholder="student@example.com">
                            </div>

                            <!-- Phone -->
                            <div class="col-md-4">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone"
                                       placeholder="+1234567890">
                            </div>

                            <!-- Academic Level -->
                            <div class="col-md-4">
                                <label class="form-label">Academic Level <span class="text-danger">*</span></label>
                                <select class="form-select" id="academicLevelId" required>
                                    <option value="">Select Level</option>
                                </select>
                            </div>

                            <!-- Department -->
                            <div class="col-md-4">
                                <label class="form-label">Department <span class="text-danger">*</span></label>
                                <select class="form-select" id="departmentId" required>
                                    <option value="">Select Department</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            <i class="bi bi-check-circle me-1"></i> Save Student
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i> Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this student?</p>
                    <p class="mb-0"><strong id="deleteStudentName"></strong></p>
                    <input type="hidden" id="deleteStudentId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/permissions-ui.js"></script>
    
    <script>
        // Global variables
        let students = [];
        let departments = [];
        let academicLevels = [];
        let isEditMode = false;
        let studentModal;
        let deleteModal;
        let canCreateStudent = false;
        let canEditStudent = false;
        let canDeleteStudent = false;
        let canViewPasswords = false;

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', async function() {
            initLayout('students');
            if (!hasPermission('student.view')) {
                window.location.href = 'dashboard.html';
                return;
            }

            canCreateStudent = hasPermission('student.create');
            canEditStudent = hasPermission('student.update');
            canDeleteStudent = hasPermission('student.delete');
            canViewPasswords = hasPermission('password.view.all') || hasPermission('password.view.student');

            if (!canCreateStudent) {
                const addBtn = document.querySelector('button[onclick="showAddModal()"]');
                if (addBtn) addBtn.classList.add('d-none');
            }

            // Show password column header if permitted
            if (canViewPasswords) {
                document.getElementById('passwordHeader').classList.remove('d-none');
            }

            // Initialize modals
            studentModal = new bootstrap.Modal(document.getElementById('studentModal'));
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

            // Load dropdown data
            await loadDropdownData();

            // Load students
            await loadStudents();

            // Setup search
            document.getElementById('searchInput').addEventListener('input', filterStudents);
            document.getElementById('filterDepartment').addEventListener('change', filterStudents);
            document.getElementById('filterLevel').addEventListener('change', filterStudents);

            // Setup form submission
            document.getElementById('studentForm').addEventListener('submit', saveStudent);

        });

        // ========================================
        // LOAD DROPDOWN DATA
        // ========================================
        async function loadDropdownData() {
            try {
                // Load academic levels - WebView already parses JSON
                academicLevels = await cpp_getAcademicLevels();
                
                const levelSelect = document.getElementById('academicLevelId');
                const filterLevel = document.getElementById('filterLevel');
                
                academicLevels.forEach(level => {
                    levelSelect.innerHTML += `<option value="${level.id}">${level.name}</option>`;
                    filterLevel.innerHTML += `<option value="${level.id}">${level.name}</option>`;
                });

                // Load departments - WebView already parses JSON
                departments = await cpp_getDepartments();
                
                const deptSelect = document.getElementById('departmentId');
                const filterDept = document.getElementById('filterDepartment');
                
                departments.forEach(dept => {
                    deptSelect.innerHTML += `<option value="${dept.id}">${dept.name}</option>`;
                    filterDept.innerHTML += `<option value="${dept.id}">${dept.name}</option>`;
                });

            } catch (error) {
                console.error('Error loading dropdown data:', error);
            }
        }

        // ========================================
        // LOAD STUDENTS
        // ========================================
        async function loadStudents() {
            try {
                // WebView already parses JSON
                students = await cpp_getAllStudents();
                displayStudents(students);
            } catch (error) {
                console.error('Error loading students:', error);
                showToast('Error loading students', 'danger');
            }
        }

        // ========================================
        // DISPLAY STUDENTS IN TABLE
        // ========================================
        function displayStudents(studentsToShow) {
            const tbody = document.getElementById('studentsTableBody');
            const colSpan = canViewPasswords ? 9 : 8;
            
            if (studentsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-4 d-block mb-2"></i>
                            No students found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = studentsToShow.map(student => {
                const genderValue = (student.gender || '').toLowerCase();
                const genderLabel = genderValue ? genderValue.charAt(0).toUpperCase() + genderValue.slice(1) : '-';
                const genderClass = genderValue === 'male' ? 'bg-primary' : 'bg-warning text-dark';
                return `
                    <tr>
                        <td><strong>${student.id}</strong></td>
                        <td>${student.fullName || student.firstName + ' ' + student.lastName}</td>
                        <td>${student.email || '-'}</td>
                        <td>${student.phone || '-'}</td>
                        <td>
                            <span class="badge ${genderClass}">${genderLabel}</span>
                        </td>
                        <td>${getLevelName(student.academicLevelId)}</td>
                        <td>${getDepartmentName(student.departmentId)}</td>
                        ${canViewPasswords ? `
                        <td>
                            <code class="text-success">${student.password || '-'}</code>
                        </td>` : ''}
                        <td class="text-center">
                            ${canEditStudent ? `
                            <button class="btn btn-sm btn-outline-primary me-1"
                                    onclick="editStudent('${student.id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>` : ''}
                            ${canDeleteStudent ? `
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="showDeleteModal('${student.id}', '${student.fullName || student.firstName + ' ' + student.lastName}')"
                                    title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========================================
        // FILTER STUDENTS
        // ========================================
        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const deptFilter = document.getElementById('filterDepartment').value;
            const levelFilter = document.getElementById('filterLevel').value;

            const filtered = students.filter(student => {
                const matchesSearch = !searchTerm || 
                    student.id.toLowerCase().includes(searchTerm) ||
                    (student.fullName && student.fullName.toLowerCase().includes(searchTerm)) ||
                    (student.firstName && student.firstName.toLowerCase().includes(searchTerm)) ||
                    (student.lastName && student.lastName.toLowerCase().includes(searchTerm)) ||
                    (student.email && student.email.toLowerCase().includes(searchTerm));
                
                const matchesDept = !deptFilter || student.departmentId === deptFilter;
                const matchesLevel = !levelFilter || student.academicLevelId === levelFilter;

                return matchesSearch && matchesDept && matchesLevel;
            });

            displayStudents(filtered);
        }

        // ========================================
        // SHOW ADD MODAL
        // ========================================
        async function showAddModal() {
            if (!canCreateStudent) {
                showToast('You do not have permission to add students', 'warning');
                return;
            }
            isEditMode = false;
            document.getElementById('modalTitle').innerHTML = 
                '<i class="bi bi-person-plus me-2"></i> Add New Student';
            document.getElementById('studentForm').reset();
            
            // Auto-generate student ID (YYYY + increment format)
            try {
                const result = await cpp_generateStudentId();
                document.getElementById('studentId').value = result.id;
                document.getElementById('studentId').disabled = true; // ID is auto-generated
            } catch (error) {
                console.error('Error generating student ID:', error);
                document.getElementById('studentId').disabled = false;
            }
            
            document.getElementById('saveBtn').innerHTML = 
                '<i class="bi bi-check-circle me-1"></i> Save Student';
            studentModal.show();
        }

        // ========================================
        // EDIT STUDENT
        // ========================================
        function editStudent(id) {
            if (!canEditStudent) {
                showToast('You do not have permission to edit students', 'warning');
                return;
            }
            const student = students.find(s => s.id === id);
            if (!student) return;

            isEditMode = true;
            document.getElementById('modalTitle').innerHTML = 
                '<i class="bi bi-pencil me-2"></i> Edit Student';
            
            // Fill form with student data
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentId').disabled = true;
            document.getElementById('firstName').value = student.firstName;
            document.getElementById('lastName').value = student.lastName;
            document.getElementById('dateOfBirth').value = student.dateOfBirth || '';
            document.getElementById('gender').value = student.gender;
            document.getElementById('email').value = student.email || '';
            document.getElementById('phone').value = student.phone || '';
            document.getElementById('academicLevelId').value = student.academicLevelId || '';
            document.getElementById('departmentId').value = student.departmentId || '';

            document.getElementById('saveBtn').innerHTML = 
                '<i class="bi bi-check-circle me-1"></i> Update Student';
            
            studentModal.show();
        }

        // ========================================
        // SAVE STUDENT
        // ========================================
        async function saveStudent(e) {
            e.preventDefault();

            if (isEditMode && !canEditStudent) {
                showToast('You do not have permission to edit students', 'warning');
                return;
            }
            if (!isEditMode && !canCreateStudent) {
                showToast('You do not have permission to add students', 'warning');
                return;
            }

            const studentData = {
                id: document.getElementById('studentId').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                dateOfBirth: document.getElementById('dateOfBirth').value || '',
                gender: document.getElementById('gender').value,
                email: document.getElementById('email').value || '',
                phone: document.getElementById('phone').value || '',
                academicLevelId: document.getElementById('academicLevelId').value,
                departmentId: document.getElementById('departmentId').value
            };

            try {
                let response;
                if (isEditMode) {
                    response = await cpp_updateStudent(studentData);
                } else {
                    response = await cpp_addStudent(studentData);
                }

                // WebView already parses JSON
                if (response.success) {
                    showToast(response.message, 'success');
                    studentModal.hide();
                    await loadStudents();
                } else {
                    showToast(response.message, 'danger');
                }

            } catch (error) {
                console.error('Error saving student:', error);
                showToast('Error saving student', 'danger');
            }
        }

        // ========================================
        // DELETE STUDENT
        // ========================================
        function showDeleteModal(id, name) {
            if (!canDeleteStudent) {
                showToast('You do not have permission to delete students', 'warning');
                return;
            }
            document.getElementById('deleteStudentId').value = id;
            document.getElementById('deleteStudentName').textContent = `${name} (${id})`;
            deleteModal.show();
        }

        async function confirmDelete() {
            if (!canDeleteStudent) {
                showToast('You do not have permission to delete students', 'warning');
                return;
            }
            const id = document.getElementById('deleteStudentId').value;

            try {
                // WebView already parses JSON
                const response = await cpp_deleteStudent(id);

                if (response.success) {
                    showToast(response.message, 'success');
                    deleteModal.hide();
                    await loadStudents();
                } else {
                    showToast(response.message, 'danger');
                }

            } catch (error) {
                console.error('Error deleting student:', error);
                showToast('Error deleting student', 'danger');
            }
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function getLevelName(id) {
            const level = academicLevels.find(l => l.id === id);
            return level ? level.name : '-';
        }

        function getDepartmentName(id) {
            const dept = departments.find(d => d.id === id);
            return dept ? dept.name : '-';
        }

        function showToast(message, type = 'success') {
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                            data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }
    </script>
</body>
</html>
