<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCTU - My Grades</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="d-flex">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-dark text-white vh-100 p-3">
            <div class="text-center mb-4">
                <i class="bi bi-mortarboard-fill display-6"></i>
                <h5 class="mb-0">NCTU</h5>
                <small class="text-white-50" style="font-size: 0.65rem;">New Cairo Technological University</small>
                <hr class="border-secondary my-2">
                <small id="userNameDisplay" class="text-white-50">Student</small>
                <br>
                <span id="userRoleBadge" class="badge bg-primary">Role</span>
            </div>
            <hr class="border-secondary">
            <ul id="sidebarMenu" class="nav flex-column"></ul>
            <hr class="border-secondary mt-auto">
            <a href="index.html" class="nav-link text-danger" onclick="sessionStorage.clear()">
                <i class="bi bi-box-arrow-left me-2"></i> Logout
            </a>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow-1 main-content">
            <!-- Header -->
            <div class="bg-white shadow-sm p-3 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-award me-2 text-warning"></i>
                        My Grades
                    </h4>
                    <button class="btn btn-outline-primary" onclick="window.print()">
                        <i class="bi bi-printer me-2"></i> Print
                    </button>
                </div>
            </div>

            <div class="container-fluid">
                <!-- GPA Summary -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm text-center">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Cumulative GPA</h6>
                                <div class="display-3 text-success fw-bold" id="cgpaDisplay">0.00</div>
                                <small class="text-muted">out of 4.00</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm text-center">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Courses Completed</h6>
                                <div class="display-3 text-primary fw-bold" id="coursesCount">0</div>
                                <small class="text-muted">total courses</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm text-center">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Credit Hours</h6>
                                <div class="display-3 text-info fw-bold" id="creditsCount">0</div>
                                <small class="text-muted">total credits</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grades Table -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-table me-2"></i>
                            Grade Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="gradesTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Course Code</th>
                                        <th>Course Name</th>
                                        <th>Type</th>
                                        <th class="text-center">Assign 1</th>
                                        <th class="text-center">Assign 2</th>
                                        <th class="text-center">Year Work</th>
                                        <th class="text-center">Final</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">%</th>
                                        <th class="text-center">GPA</th>
                                        <th class="text-center">Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="gradesTableBody">
                                    <tr>
                                        <td colspan="11" class="text-center">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Grade Legend -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Grading Scale
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Percentage</th>
                                            <th>Evaluation</th>
                                            <th>GPA</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-success">
                                            <td>85% - 100%</td>
                                            <td>Excellent</td>
                                            <td>4.0</td>
                                        </tr>
                                        <tr class="table-info">
                                            <td>75% - 84%</td>
                                            <td>Very Good</td>
                                            <td>3.0</td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td>65% - 74%</td>
                                            <td>Good</td>
                                            <td>2.0</td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td>60% - 64%</td>
                                            <td>Pass</td>
                                            <td>1.0</td>
                                        </tr>
                                        <tr class="table-danger">
                                            <td>Below 60%</td>
                                            <td>Fail</td>
                                            <td>0.0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Grade Components:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Assignment 1:</strong> First assignment</li>
                                    <li><strong>Assignment 2:</strong> Second assignment</li>
                                    <li><strong>Year Work:</strong> Ongoing assessment</li>
                                    <li><strong>Final:</strong> Final exam</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const studentId = sessionStorage.getItem('linkedId');
            if (!studentId || !isRole('ROLE_STUDENT')) {
                window.location.href = 'index.html';
                return;
            }

            initLayout('my-grades');
            await loadGrades(studentId);
        });

        function valueOrDefault(value, fallback) {
            return value === undefined || value === null ? fallback : value;
        }

        async function loadGrades(studentId) {
            try {
                const grades = await cpp_getStudentGrades(studentId);
                const cgpaData = await cpp_getStudentCGPA(studentId);

                document.getElementById('cgpaDisplay').textContent = 
                    (cgpaData.cgpa || 0).toFixed(2);

                let totalCredits = 0;
                if (grades && grades.length) {
                    grades.forEach(g => {
                        totalCredits += g.creditHours || 3;
                    });
                }

                document.getElementById('coursesCount').textContent = grades ? grades.length : 0;
                document.getElementById('creditsCount').textContent = totalCredits;

                const tbody = document.getElementById('gradesTableBody');
                
                if (!grades || grades.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                No grades available yet
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = grades.map(grade => {
                    const semesterNote = grade.semesterName ? `<br><small class="text-muted">${grade.semesterName}</small>` : '';
                    // Check if grades have been entered - show "Pending" if not
                    const gradesEntered = grade.gradesEntered === true || grade.gradesEntered === 'true';
                    const displayEvaluation = gradesEntered ? grade.evaluation : 'Pending';
                    const displayGpa = gradesEntered ? valueOrDefault(grade.gpa, 0).toFixed(2) : '-';
                    const displayPercentage = gradesEntered ? valueOrDefault(grade.percentage, 0).toFixed(1) + '%' : '-';
                    
                    return `
                    <tr>
                        <td><strong>${grade.courseCode}</strong></td>
                        <td>${grade.courseName}${semesterNote}</td>
                        <td>
                            <span class="badge ${getTypeBadge(grade.courseType)}">
                                ${formatCourseType(grade.courseType)}
                            </span>
                        </td>
                        <td class="text-center">${valueOrDefault(grade.assignment1, 0).toFixed(1)}</td>
                        <td class="text-center">${valueOrDefault(grade.assignment2, 0).toFixed(1)}</td>
                        <td class="text-center">${valueOrDefault(grade.yearWork, 0).toFixed(1)}</td>
                        <td class="text-center">${valueOrDefault(grade.finalExam, 0).toFixed(1)}</td>
                        <td class="text-center"><strong>${valueOrDefault(grade.total, 0).toFixed(1)}</strong> / ${grade.maxMarks}</td>
                        <td class="text-center">${displayPercentage}</td>
                        <td class="text-center"><strong>${displayGpa}</strong></td>
                        <td class="text-center">
                            <span class="badge ${getGradeBadgeClass(displayEvaluation)}">
                                ${displayEvaluation}
                            </span>
                        </td>
                    </tr>
                `}).join('');

            } catch (error) {
                console.error('Error loading grades:', error);
            }
        }

        function formatCourseType(type) {
            return type || '-';
        }

        function getTypeBadge(type) {
            if (!type) return 'bg-secondary';
            const name = type.toLowerCase();
            if (name.includes('practical')) return 'bg-info';
            if (name.includes('project')) return 'bg-warning text-dark';
            if (name.includes('theoretical') || name.includes('theory')) return 'bg-secondary';
            return 'bg-primary';
        }

        function getGradeBadgeClass(evaluation) {
            const classes = {
                'Excellent': 'bg-success',
                'Very Good': 'bg-info',
                'Good': 'bg-primary',
                'Pass': 'bg-warning text-dark',
                'Fail': 'bg-danger',
                'Pending': 'bg-secondary'
            };
            return classes[evaluation] || 'bg-secondary';
        }
    </script>
</body>
</html>
